<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endless Complexity</title>
    <link rel="stylesheet" href="style.css"/>
    <script defer src="Model.js"></script>
    <script defer src="View.js"></script>
    <script defer src="Events.js"></script>

</head>
<body>
    <div id="app"></div>
</body>

<script>

    //Controller

    // Called from fightSequence() function - Returns a healthpotion one out of 10 times
    function addHealthPotionReward() {
        let chanceOfPot = Math.ceil(Math.random()*10);
        if (chanceOfPot === 10 && player.inventory > 0) {
            player.inventory -= 1;
            return 1;
        }
        else return 0;
    }


    // Called from fightSequence() function - Returns total damage after accounting for weapon, player and powerup damage.
    function calculateDamage() {
        if (player.attackUP > 0 && player.health <= 50) {
            player.attackUP -= 1;
            player.inventory += 1;
            powerUP = player.ad;
        }

        weaponDamage = addWeaponDamage();

        damage = weaponDamage + player.ad + powerUP;
        return damage;
    }

    // Called from fightSequence() function - Returns weapon damage after checking the equipped weapon.
    function addWeaponDamage() {
        //Default weapon
        if (player.weapon == "Stick" && weaponType == "Default") return 3; //Adds +3 damage to attack

    }

    //Called from fightSequence() function - Returns weapon speed after checking the equipped weapon.
    function addWeaponSpeed() {
        //Default weapon
        if (player.weapon == "Stick" && weaponType == "Default") return 5; //Weapon speed is 5

    }

    // Called from fightSequence() function - Ends fightSequence function, removes courage to prevent loop, removes some gold, returns to idle.
    function flee() {
        if (fleeTime == false) return;
        fleeTime == false;
        if (strikeTime == false) return;
        strikeTime = false;
        winOrLose = 'You fled from the battle and lost some gold.';
        updateView();
        player.courage = 0;
        player.gold -= 5;
        if (player.gold < 0) player.gold = 0;
        setTimeout(()=>{
            player.health = 100;
            status = 'You are home.';
            currentMonster = {name:'N/A',health:'N/A'};
            eventTime = true;
            fleeTime = true;
            strikeTime = true;
            monsterName = 'N/A';
            monsterHealth = 'N/A';
            winOrLose = '';
            firstAction = `<button class="actionButton" onclick="selectEvent('Fight')">Fight</button>`;
            secondAction = `<button class="actionButton" onclick="selectEvent('Explore')">Explore</button>`;
            thirdAction = `<button class="actionButton" onclick="selectEvent('Farm')">Farm</button>`;
            fourthAction = `<button class="actionButton" onclick="selectEvent('Study')">Study</button>`;
            updateView();},3000);
        return;
    }

    //Called from selectEvent() function - Returns a treasure event based on random logic.
    function randomTreasureEvent() {
        //Pick a treasure event at random
        const random = Math.ceil(Math.random() * 10);
        if (round == 10) return castle;
        else return forest;

    }

    //Called from selectEvent() function - Returns a monster based on random logic.
    function randomMonster() {
        //Reset all monster health
        goblin.health = 30 + Math.ceil(Math.random()*30);
        goblinBoss.health = 60 + Math.ceil(Math.random()*60);

        //Pick monster at random
        random = Math.ceil(Math.random() * 10);
        if (round == 10 || round == 20 || round == 30) return goblinBoss;
        if (random == 10 && round > 10) return goblinBoss;
        else return goblin;
    }

    //Called from onclick event in "fight" box.
    function selectEvent(boxID) {
        //Prevents two events running at the same time - eventTime returns to true at the end of each event.
        if (eventTime == false) return;
        eventTime = false;

        //Increases round by 1 and resets the player's health so they can fight.
        round += 1;
        player.health = 100;

        //Loading event visible on screen
        status = 'Loading event...';
        updateView();

        if (boxID == "Rest" && player.health < 50) {
            status = 'You take a couple days off to rest, recovering from your wounds.';
            round +=2;
            updateView();
            setTimeout(()=>{status='You are home.';player.health = 100;updateView();eventTime=true;}, 3000);
        }

        //Checks what box was clicked and selects appropriate event
        if (boxID == 'Fight') {
            setTimeout(()=>{fightSequence(randomMonster())}, 3000);

        }
        else if (boxID == 'Explore') {
                status = 'Event is not finished, try again later.'
                updateView()
                setTimeout(()=>{status='You are home.';updateView();eventTime=true;}, 3000);

        }
        else if (boxID == 'Farm') {
                status = 'Event is not finished, try again later.'
                updateView()
                setTimeout(()=>{status='You are home.';updateView();eventTime=true;}, 3000);

        }
        else if (boxID == 'Study') {
                status = 'Event is not finished, try again later.'
                updateView()
                setTimeout(()=>{status='You are home.';updateView();eventTime=true;}, 3000);

        }
    }

    //Called from 50gp button in the bottom left box.
    function buyAttackUp() {
        console.log(player.attackUP);
        if (player.gold >= 50 && player.inventory > 0) {
            player.gold -= 50;
            player.inventory -= 1;
            player.attackUP += 1;
            updateView();
        }
        else alert("Check if you have enough gold or inventory space.");

    }

    function buyHealthPotion() {
        console.log(player.healthpotions);
        if (player.gold >= 25 && player.inventory > 0) {
            player.gold -= 25;
            player.inventory -= 1;
            player.healthpotions += 1;
            updateView();
        }
        else alert("Check if you have enough gold or inventory space.");
    }

    function checkDead() {
        if (player.health < 1) death();

        if (currentMonster.health < 1) reward();

    }

    function reward() {
        status = 'You beat the ' + currentMonster.name + ' and got some loot!';
        updateView();
        if (currentMonster.name == "Goblin") {
            currentMonster = {name:'N/A',health:'N/A'};
            player.gold += Math.ceil(Math.random()*30)
            updateView();
            setTimeout(()=> {
                eventTime = true;
                strikeTime = true;
                firstAction = `<button class="actionButton" onclick="selectEvent('Fight')">Fight</button>`;
                secondAction = `<button class="actionButton" onclick="selectEvent('Explore')">Explore</button>`;
                thirdAction = `<button class="actionButton" onclick="selectEvent('Farm')">Farm</button>`;
                fourthAction = `<button class="actionButton" onclick="selectEvent('Study')">Study</button>`;
                status = 'You are home.';
                player.health = 100;
                updateView();
            },3000)
        }
        else {
            setTimeout(()=> {
                currentMonster = {name:'N/A',health:'N/A'};
                alert('You should not have done that.');
                eventTime = true;
                strikeTime = true;
                firstAction = `<button class="actionButton" onclick="selectEvent('Fight')">Fight</button>`;
                secondAction = `<button class="actionButton" onclick="selectEvent('Explore')">Explore</button>`;
                thirdAction = `<button class="actionButton" onclick="selectEvent('Farm')">Farm</button>`;
                fourthAction = `<button class="actionButton" onclick="selectEvent('Study')">Study</button>`;
                status = 'You are home.';
                player.health = 100;
                updateView();
            },3000)
        }

    }

    function death() {
        status = 'Oh dear, you have met your demise. Try again from the start.'
        updateView();
        player = {
        name: playerName,
        health: 0,
        ad: 3, // Attack damage
        speed: 5,
        weapon: "Stick",
        //Inventory:
        inventory: 10,
        gold: 10,
        healthpotions: 0,
        attackUP: 0,

        //Status:
        courage: 1,
        }
        updateView();
        setTimeout(()=> {
                currentMonster = {name:'N/A',health:'N/A'};
                eventTime = true;
                firstAction = `<button class="actionButton" onclick="selectEvent('Fight')">Fight</button>`;
                secondAction = `<button class="actionButton" onclick="selectEvent('Explore')">Explore</button>`;
                thirdAction = `<button class="actionButton" onclick="selectEvent('Farm')">Farm</button>`;
                fourthAction = `<button class="actionButton" onclick="selectEvent('Study')">Study</button>`;
                status = 'You are home.';
                updateView();
            },3000)
    }

</script>
</html>
